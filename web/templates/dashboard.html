<!doctype html>
<html>
<head>
  <title>ToniePi Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
  <span class="navbar-brand">ToniePi</span>
  <span class="text-white">Logged in as {{ user }}</span>
  <a href="/logout" class="btn btn-sm btn-outline-light">Logout</a>
</nav>

<div class="container mt-4">

  <h4>Upload Audio</h4>

  <div id="drop-area" class="border border-2 border-primary p-5 text-center bg-white">
    Drag & Drop Files Here
  </div>

  <progress id="progress" value="0" max="100" class="w-100 mt-2"></progress>

  <hr>

    <h4>Live Tag Detection</h4>

    <div class="alert alert-info">
    Last scanned tag:
    <strong id="liveTag">None</strong>
    <button class="btn btn-sm btn-success ms-3" onclick="useLiveTag()">Use for Assignment</button>
    </div>

  <hr>

  <h4>Assign Tag</h4>
  <div class="row">
    <div class="col-md-4">
      <input id="uid" class="form-control" placeholder="Tag UID">
    </div>
    <div class="col-md-4">
      <select id="fileSelect" class="form-select">
        {% for f in audio_files %}
        <option value="{{ f }}">{{ f }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary w-100" onclick="assignTag()">Assign</button>
    </div>
  </div>

  <hr>

  <h4>Audio Files</h4>
  <ul id="fileList" class="list-group">
    {% for f in tags %}
    <li class="list-group-item d-flex justify-content-between">
      {{ f.filename }}
      <button class="btn btn-sm btn-danger" onclick="deleteFile('{{ f }}')">Delete</button>
    </li>
    {% endfor %}
  </ul>

</div>

<script>
const dropArea = document.getElementById("drop-area");
const progress = document.getElementById("progress");

dropArea.addEventListener("dragover", e => {
  e.preventDefault();
  dropArea.classList.add("bg-info");
});

dropArea.addEventListener("drop", e => {
  e.preventDefault();
  dropArea.classList.remove("bg-info");
  uploadFile(e.dataTransfer.files[0]);
});

function uploadFile(file) {
  let formData = new FormData();
  formData.append("file", file);

  let xhr = new XMLHttpRequest();
  xhr.open("POST", "/api/upload");

  xhr.upload.onprogress = e => {
    progress.value = (e.loaded / e.total) * 100;
  };

  xhr.onload = () => location.reload();
  xhr.send(formData);
}

function assignTag() {
  fetch("/api/tags", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      uid: document.getElementById("uid").value,
      filename: document.getElementById("fileSelect").value
    })
  }).then(() => location.reload());
}

function deleteFile(filename) {
  fetch("/api/files/" + filename, {method: "DELETE"})
    .then(() => location.reload());
}
</script>

</body>
</html>

<script>
const evtSource = new EventSource("/api/stream");

evtSource.onmessage = function(event) {
    document.getElementById("liveTag").innerText = event.data;
};

function useLiveTag() {
    const tag = document.getElementById("liveTag").innerText;
    if (tag !== "None") {
        document.getElementById("uid").value = tag;
    }
}
</script>